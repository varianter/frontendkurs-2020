import {
  CodeSurfer,
  CodeSurferColumns,
  Step,
} from 'code-surfer';

import {
  Image,
  Invert,
  Notes,
  Split,
  SplitRight,
  Appear,
  Head,
} from 'mdx-deck';

import { github, dracula } from '@code-surfer/themes';
import customTheme from '../custom-theme';
export const theme = customTheme(dracula);

import ImageLayout from '../image-split-layout';
import * as imgs from '../images';

<Head>
  <title>Frontendkurs – React Hooks</title>
  {Object.values(imgs).map(function (img) {
    <link rel="preload" as="image" href={img} />;
  })}
</Head>

<Image
  src={imgs.bg}
  style={{
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    paddingRight: '1rem',
    color: 'black',
    backgroundColor: 'black',
  }}
>


# Frontendkurs 2020

</Image>


---

## Agenda

1. ~~Universell utforming~~
1. ~~React & TypeScript~~
1. React Hooks

---

<Image
  src={imgs.bg}
  style={{
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    paddingRight: '1rem',
    color: 'black',
    backgroundColor: 'black',
  }}
>


## React Hooks

</Image>


<Notes>


</Notes>


---

1. Innebygde hooks
1. Mer om `useEffect`
1. Egne hooks & typing
1. Context & `useContext`

---

## The why

<Notes>


Men hvorfor er det en greie?

Kort oppsummert: Målet er gjenbrukbarhet. Med tidligere måter å håndtere
lokal tilstand på så så man at det var vanskelig å dele det på tvers av komponenter
på en naturlig måte.

For de som har skrevet React lenge er det ikke så ulikt et konsept fra tidlige dager
med mixins, bare at dette er en noe mer funksjonell tilnærmingsmåte.

</Notes>


---

<CodeSurferColumns themes={[dracula, github]} sizes={[1,2]}>


<Step>


## The how

```ts
import React, { useState } from 'react';

function CounterButton() {
  const [count, setCount] = useState(0);

  return (
    <button onClick={() => setCount(count + 1)}>
      {count}
    </button>
  );
}
```

</Step>


<Step>


## The how

```md
1. Kun på toppnivå
2. Ikke noe conditionals
3. Kun fra komponenter (eller via custom hooks)
```

</Step>


</CodeSurferColumns>


<Notes>


Hooks! Selv om det ikke har fjernet støtte for noe som har eksistert
fra før så har det erstattet det meste av etablerte patterns i React.

</Notes>


---

## Forskjellige typer hooks

1. Tilstand (`useState`, `useReducer`, `useContext`)
1. Lytting på data (`useEffect`, `useCallback`, `useMemo`, ++)
1. Hjelpe-hooks (`useRef`, ++)

---

## Tilstand

---

<CodeSurfer>


```ts
import React, { useState } from 'react';

function CounterButton() {
  const [count, setCount] = useState<number>(0);

  return (
    <button onClick={() => setCount(count + 1)}>
      {count}
    </button>
  );
}
```

```ts 4[37:44]
import React, { useState } from 'react';

function CounterButton() {
  const [count, setCount] = useState<number>(0);

  return (
    <button onClick={() => setCount(count + 1)}>
      {count}
    </button>
  );
}
```

```ts 4[45:47]
import React, { useState } from 'react';

function CounterButton() {
  const [count, setCount] = useState<number>(0);

  return (
    <button onClick={() => setCount(count + 1)}>
      {count}
    </button>
  );
}
```

```ts 4[9:26]
import React, { useState } from 'react';

function CounterButton() {
  const [count, setCount] = useState<number>(0);

  return (
    <button onClick={() => setCount(count + 1)}>
      {count}
    </button>
  );
}
```

```ts
import React, { useState } from 'react';

function CounterButton() {
  const stateTuple: [
    number,
    (newValue: number) => void,
  ] = useState<number>(0);

  return (
    <button onClick={() => setCount(count + 1)}>
      {count}
    </button>
  );
}
```

```ts
import React, { useState } from 'react';

function CounterButton() {
  const stateTuple: [
    number,
    (newValue: number) => void,
  ] = useState<number>(0);

  const [count, setCount] = stateTuple;

  return (
    <button onClick={() => setCount(count + 1)}>
      {count}
    </button>
  );
}
```

```ts
import React, { useState } from 'react';

function CounterButton() {
  const [count, setCount] = useState<number>(0);

  return (
    <button onClick={() => setCount(count + 1)}>
      {count}
    </button>
  );
}
```

```ts
import React, { useState } from 'react';

function CounterButton() {
  const [count, setCount] = useState(0);

  return (
    <button onClick={() => setCount(count + 1)}>
      {count}
    </button>
  );
}
```

</CodeSurfer>


---

<CodeSurferColumns themes={[dracula, github]} sizes={[1,2]}>


<Step>


## Også for komplekse objekter

```ts
import React, { useState } from 'react';

function CounterButton() {
  const [state, setState] = useState({ count: 0, next: 1 });

  return (
    <button
      onClick={() =>
        setState({
          count: state.count + 1,
          next: state.next + 1,
        })
      }
    >
      {state.count} (neste: {state.next})
    </button>
  );
}
```

</Step>


<Step>


## Men kan spre ut i flere states

```ts
import React, { useState } from 'react';

function CounterButton() {
  const [count, setCount] = useState(0);
  const [next, setNext] = useState(1);

  const update = () => {
    setCount(count + 1);
    setNext(next + 1);
  };

  return (
    <button onClick={update}>
      {count} (neste: {next})
    </button>
  );
}
```

</Step>


<Step subtitle="But does it scale?">


## Men kan spre ut i flere states

```ts
import React, { useState } from 'react';

function CounterButton() {
  const [count, setCount] = useState(0);
  const [next, setNext] = useState(1);

  const update = () => {
    setCount(count + 1);
    setNext(next + 1);
  };

  return (
    <button onClick={update}>
      {count} (neste: {next})
    </button>
  );
}
```

</Step>


</CodeSurferColumns>


---

### `useReducer`

Om du vil ha kompleks, avhengig tilstand.

---

<CodeSurfer>


```ts
import React, { useReducer } from 'react';

type CounterState = {
  count: number;
  next: number;
};

type CounterActions =
  | {
      type: 'COUNT_INCREMENT';
    }
  | {
      type: 'COUNT_DECREMENT';
    };

const initialState: CounterState = {
  count: 0,
  next: 1,
};

const counterReducer: React.Reducer<
  CounterState,
  CounterActions
> = (state, action) => {
  switch (action.type) {
    case 'COUNT_INCREMENT':
      return {
        count: state.count + 1,
        next: state.next + 1,
      };
    case 'COUNT_DECREMENT':
      if (state.next === 0) {
        return state;
      }

      return {
        count: state.count - 1,
        next: state.next - 1,
      };
  }
};

function CounterButton() {
  const [state, dispatch] = useReducer(
    counterReducer,
    initialState,
  );
  const increment = () =>
    dispatch({ type: 'COUNT_INCREMENT' });
  const decrement = () =>
    dispatch({ type: 'COUNT_DECREMENT' });

  return (
    <div>
      <p>{state.count}</p>
      <button onClick={increment}>Increment</button>
      <button onClick={decrement}>Decrement</button>
    </div>
  );
}
```

```diff 3:6

```

```diff 16:19

```

```diff 8:14

```

```diff 21:41

```

```diff 26,31

```

```diff 44:47

```

```diff 48:51

```

```diff 55:57

```

</CodeSurfer>


---

## Oppgaver

1. Lag en komponent som skriver ut tekst fra en input-boks

---

## Lytting på data

---

<CodeSurferColumns themes={[dracula, github]} sizes={[1,2]}>


<Step>


### `useMemo`

```ts
type ListProps = {
  data: string[];
};
function List({ data }: ListProps) {
  const sortedList = React.useMemo(
    () => data.sort(sortByName),
    [data],
  );

  return (
    <ul>
      {sortedList.map((val) => (
        <li key={val}>{val}</li>
      ))}
    </ul>
  );
}

function sortByName() {
  // implementation
}
```

</Step>


<Step>


### `useMemo`

```diff 5:8

```

</Step>


<Step>


### `useMemo`

```diff 7

```

</Step>


</CodeSurferColumns>


---

<CodeSurferColumns themes={[dracula, github]} sizes={[1,2]}>


<Step>


### `Object.is`

```ts
Object.is('foo', 'foo'); // true
```

</Step>


<Step>


### `Object.is`

```ts
Object.is('foo', 'foo'); // true
Object.is(NaN, NaN); // true
```

</Step>


<Step>


### `Object.is`

```ts
Object.is('foo', 'foo'); // true
Object.is(NaN, NaN); // true
Object.is(NaN, 'NaN'); // false
```

</Step>


<Step>


### `Object.is`

```ts
Object.is('foo', 'foo'); // true
Object.is(NaN, NaN); // true
Object.is(NaN, 'NaN'); // false
Object.is({}, {}); // false
```

</Step>


<Step>


### `Object.is`

```ts
let foo = {};
Object.is(foo, foo); // true
```

</Step>


<Step>


### `useMemo`

```ts 7
type ListProps = {
  data: string[];
};
function List({ data }: ListProps) {
  const sortedList = React.useMemo(
    () => data.sort(sortByName),
    [data],
  );

  return (
    <ul>
      {sortedList.map((val) => (
        <li key={val}>{val}</li>
      ))}
    </ul>
  );
}

function sortByName() {
  // implementation
}
```

</Step>


<Step>


### `useMemo`

```ts 7
type ListProps = {
  data: string[];
};
function List({ data }: ListProps) {
  const sortedList = React.useMemo(
    () => data.sort(sortByName),
    [],
  );

  return (
    <ul>
      {sortedList.map((val) => (
        <li key={val}>{val}</li>
      ))}
    </ul>
  );
}

function sortByName() {
  // implementation
}
```

</Step>


</CodeSurferColumns>


---

<CodeSurfer >


```ts 3 subtitle="Hva om vi får med sort?"
type ListProps = {
  data: string[];
  sortFn(val: string[]): string[];
};
function List({ data, sortFn }: ListProps) {
  const sortedList = React.useMemo(() => sortFn(data), [
    data,
  ]);

  // rest of function here...
}
```

```ts
type ListProps = {
  data: string[];
  sortFn(val: string[]): string[];
};
function List({ data, sortFn }: ListProps) {
  const sortedList = React.useMemo(() => sortFn(data), [
    data,
    sortFn,
  ]);

  // rest of function here...
}
```

```ts
function MyApp() {
  return (
    <List data={['a', 'b', 'c']} sortFn={(l) => l.sort()} />
  );
}

type ListProps = {
  data: string[];
  sortFn(val: string[]): string[];
};
function List({ data, sortFn }: ListProps) {
  const sortedList = React.useMemo(() => sortFn(data), [
    data,
    sortFn,
  ]);

  // rest of function here...
}
```

```ts
function MyApp() {
  // Hva skjer med sortFn her?
  return (
    <List data={['a', 'b', 'c']} sortFn={(l) => l.sort()} />
  );
}

type ListProps = {
  data: string[];
  sortFn(val: string[]): string[];
};
function List({ data, sortFn }: ListProps) {
  const sortedList = React.useMemo(() => sortFn(data), [
    data,
    sortFn,
  ]);

  // rest of function here...
}
```

```ts
function MyApp() {
  const cachedSortFn = React.useCallback(
    (l: string[]) => l.sort(),
    [],
  );
  return (
    <List data={['a', 'b', 'c']} sortFn={cachedSortFn} />
  );
}

type ListProps = {
  data: string[];
  sortFn(val: string[]): string[];
};
function List({ data, sortFn }: ListProps) {
  const sortedList = React.useMemo(() => sortFn(data), [
    data,
    sortFn,
  ]);

  // rest of function here...
}
```

</CodeSurfer>


---

### `useEffect`

---

<CodeSurfer>


```ts
useEffect(
  () => {
    // function body
  },
  [
    /* dependencies */
  ],
);
```

```ts
function MyComponent() {
  useEffect(
    () => {
      // function body
    },
    [
      /* dependencies */
    ],
  );

  return <h1>Hello, World!</h1>;
}
```

```ts
function MyComponent() {
  useEffect(
    () => {
      // Når kjøres dette?
    },
    [
      /* dependencies */
    ],
  );

  return <h1>Hello, World!</h1>;
}
```

```ts
function MyComponent() {
  useEffect(
    () => {
      // Hva kan kjøres inne her?
    },
    [
      /* dependencies */
    ],
  );

  return <h1>Hello, World!</h1>;
}
```

```ts
function MyComponent() {
  useEffect(() => {
    document.title = 'Hello, World!';
  }, []);

  return <h1>Hello, World!</h1>;
}
```

```ts
function MyComponent({ title }: { title: string }) {
  useEffect(() => {
    document.title = 'Hello, World!';
  }, []);

  return <h1>Hello, World!</h1>;
}
```

```ts
function MyComponent({ title }: { title: string }) {
  useEffect(() => {
    document.title = title;
  }, []);

  return <h1>{title}</h1>;
}
```

```ts
function MyComponent({ title }: { title: string }) {
  useEffect(() => {
    document.title = title;
  }, [title]);

  return <h1>{title}</h1>;
}
```

</CodeSurfer>


---

<CodeSurferColumns themes={[dracula, github]} sizes={[1,2]}>


<Step>


## Bivirkninger

```ts
type AvatarProps = {
  username: string;
};

function Avatar({ username }: AvatarProps) {
  const [avatar, setAvatar] = React.useState<string | null>(
    null,
  );
  React.useEffect(() => {
    const getData = async () => {
      const result = await fetch(
        `https://api.github.com/users/${username}`,
      );
      const data = await result.json();

      setAvatar(data.avatar_url);
    };

    getData();
  }, [username]);

  if (!avatar) {
    return <p>Not found</p>;
  }

  return <img src={avatar} alt={username} />;
}
```

</Step>


<Step>


## Bivirkninger

```ts
type AvatarProps = {
  username: string;
};

function Avatar({ username }: AvatarProps) {
  const [avatar, setAvatar] = React.useState<string | null>(
    null,
  );

  if (!avatar) {
    return <p>Not found</p>;
  }

  return <img src={avatar} alt={username} />;
}
```

</Step>


<Step>


## Bivirkninger

```ts 6[17:26] subtitle="Denne er ubrukt"
type AvatarProps = {
  username: string;
};

function Avatar({ username }: AvatarProps) {
  const [avatar, setAvatar] = React.useState<string | null>(
    null,
  );

  if (!avatar) {
    return <p>Not found</p>;
  }

  return <img src={avatar} alt={username} />;
}
```

</Step>


<Step>


## Bivirkninger

```ts
type AvatarProps = {
  username: string;
};

function Avatar({ username }: AvatarProps) {
  const [avatar, setAvatar] = React.useState<string | null>(
    null,
  );

  React.useEffect(() => {
    // noe med setAvatar
  }, [username]);

  if (!avatar) {
    return <p>Not found</p>;
  }

  return <img src={avatar} alt={username} />;
}
```

</Step>


<Step>


## Bivirkninger

```ts
type AvatarProps = {
  username: string;
};

function Avatar({ username }: AvatarProps) {
  const [avatar, setAvatar] = React.useState<string | null>(
    null,
  );

  React.useEffect(() => {
    fetch(`https://api.github.com/users/${username}`)
      .then((result) => result.json())
      .then((data) => data.avatar_url)
      .then(setAvatar);
  }, [username]);

  if (!avatar) {
    return <p>Not found</p>;
  }

  return <img src={avatar} alt={username} />;
}
```

</Step>


<Step>


## Bivirkninger

```ts subtitle="Hva med async/await?"
type AvatarProps = {
  username: string;
};

function Avatar({ username }: AvatarProps) {
  const [avatar, setAvatar] = React.useState<string | null>(
    null,
  );

  React.useEffect(() => {
    fetch(`https://api.github.com/users/${username}`)
      .then((result) => result.json())
      .then((data) => data.avatar_url)
      .then(setAvatar);
  }, [username]);

  if (!avatar) {
    return <p>Not found</p>;
  }

  return <img src={avatar} alt={username} />;
}
```

</Step>


<Step>


## Bivirkninger

```ts subtitle="Hva med async/await?"
type AvatarProps = {
  username: string;
};

function Avatar({ username }: AvatarProps) {
  const [avatar, setAvatar] = React.useState<string | null>(
    null,
  );

  React.useEffect(() => {
    const getData = async () => {};
  }, [username]);

  if (!avatar) {
    return <p>Not found</p>;
  }

  return <img src={avatar} alt={username} />;
}
```

</Step>


<Step>


## Bivirkninger

```ts subtitle="Hva med async/await?"
type AvatarProps = {
  username: string;
};

function Avatar({ username }: AvatarProps) {
  const [avatar, setAvatar] = React.useState<string | null>(
    null,
  );

  React.useEffect(() => {
    const getData = async () => {
      const result = await fetch(
        `https://api.github.com/users/${username}`,
      );
      const data = await result.json();
      setAvatar(data.avatar_url);
    };
    getData();
  }, [username]);

  if (!avatar) {
    return <p>Not found</p>;
  }

  return <img src={avatar} alt={username} />;
}
```

</Step>


</CodeSurferColumns>


---

## Oppgaver

1. Lag en komponent som viser tekst fra navn som ligger i URL Query Parameter.
1. Lag en komponent som viser et "Github visittkort" av bruker spesifisert av URL Query Parameter

---

<CodeSurferColumns>


<Step>


## Clean-up

```ts subtitle="Hva om vi har noe som dette?"
type AvatarProps = {
  username: string;
};

function Avatar({ username }: AvatarProps) {}

function App() {
  const [username, setUsername] = React.useState<string>(
    'mikaelbr',
  );
  const toggle = () =>
    setUsername(
      username === 'mikaelbr'
        ? 'mathiasflaatt'
        : 'mikaelbr',
    );

  return (
    <div className="App">
      <div>
        <button onClick={toggle}>Toggle avatar</button>
      </div>
      <Avatar username={username} />
    </div>
  );
}
```

</Step>


<Step>


## Clean-up

```ts subtitle="Mye unødvendig API kall"
type AvatarProps = {
  username: string;
};

function Avatar({ username }: AvatarProps) {
  const [avatar, setAvatar] = React.useState<string | null>(
    null,
  );

  React.useEffect(() => {
    const getData = async () => {
      const result = await fetch(
        `https://api.github.com/users/${username}`,
      );
      const data = await result.json();
      setAvatar(data.avatar_url);
    };
    getData();
  }, [username]);

  if (!avatar) {
    return <p>Not found</p>;
  }

  return <img src={avatar} alt={username} />;
}

function App() {}
```

</Step>


<Step>


## Clean-up

```ts subtitle="Kan bruke cleanup i effects"
type AvatarProps = {
  username: string;
};

function Avatar({ username }: AvatarProps) {
  const [avatar, setAvatar] = React.useState<string | null>(
    null,
  );

  React.useEffect(() => {
    const controller = new AbortController();
    const getData = async () => {
      const opts = { signal: controller.signal };
      const result = await fetch(
        `https://api.github.com/users/${username}`,
        opts,
      );
      const data = await result.json();

      setAvatar(data.avatar_url);
    };

    getData();
    return () => controller.abort();
  }, [username]);

  if (!avatar) {
    return <p>Not found</p>;
  }

  return <img src={avatar} alt={username} />;
}

function App() {}
```

</Step>


<Step>


## Clean-up

```ts subtitle="http://var.show/akva-cleanup"
type AvatarProps = {
  username: string;
};

function Avatar({ username }: AvatarProps) {
  const [avatar, setAvatar] = React.useState<string | null>(
    null,
  );

  React.useEffect(() => {
    const controller = new AbortController();
    const getData = async () => {
      const opts = { signal: controller.signal };
      const result = await fetch(
        `https://api.github.com/users/${username}`,
        opts,
      );
      const data = await result.json();

      setAvatar(data.avatar_url);
    };

    getData();
    return () => controller.abort();
  }, [username]);

  if (!avatar) {
    return <p>Not found</p>;
  }

  return <img src={avatar} alt={username} />;
}

function App() {}
```

</Step>


</CodeSurferColumns>


---

## Custom Hooks

---

<CodeSurfer>


```ts subtitle="Dette er vanskelig å lese"
type AvatarProps = {
  username: string;
};

function Avatar({ username }: AvatarProps) {
  const [avatar, setAvatar] = React.useState<string | null>(
    null,
  );

  React.useEffect(() => {
    const controller = new AbortController();
    const getData = async () => {
      const opts = { signal: controller.signal };
      const result = await fetch(
        `https://api.github.com/users/${username}`,
        opts,
      );
      const data = await result.json();

      setAvatar(data.avatar_url);
    };

    getData();
    return () => controller.abort();
  }, [username]);

  if (!avatar) {
    return <p>Not found</p>;
  }

  return <img src={avatar} alt={username} />;
}
```

```ts 6:26 subtitle="Alt dette hører sammen og er gjenbrukbart"
type AvatarProps = {
  username: string;
};

function Avatar({ username }: AvatarProps) {
  const [avatar, setAvatar] = React.useState<string | null>(
    null,
  );

  React.useEffect(() => {
    const controller = new AbortController();
    const getData = async () => {
      const opts = { signal: controller.signal };
      const result = await fetch(
        `https://api.github.com/users/${username}`,
        opts,
      );
      const data = await result.json();

      setAvatar(data.avatar_url);
    };

    getData();
    return () => controller.abort();
  }, [username]);

  if (!avatar) {
    return <p>Not found</p>;
  }

  return <img src={avatar} alt={username} />;
}
```

```ts
function useFetchGithubAvatar(username: string) {
  const [avatar, setAvatar] = React.useState<string | null>(
    null,
  );

  React.useEffect(() => {
    const controller = new AbortController();
    const getData = async () => {
      const opts = { signal: controller.signal };
      const result = await fetch(
        `https://api.github.com/users/${username}`,
        opts,
      );
      const data = await result.json();

      setAvatar(data.avatar_url);
    };

    getData();
    return () => controller.abort();
  }, [username]);

  return avatar;
}
```

```ts
type AvatarProps = {
  username: string;
};

function Avatar({ username }: AvatarProps) {
  const avatar = useFetchGithubAvatar(username);

  if (!avatar) {
    return <p>Not found</p>;
  }

  return <img src={avatar} alt={username} />;
}
```

```ts subtitle="Det var bedre!"
type AvatarProps = {
  username: string;
};

function Avatar({ username }: AvatarProps) {
  const avatar = useFetchGithubAvatar(username);

  if (!avatar) {
    return <p>Not found</p>;
  }

  return <img src={avatar} alt={username} />;
}
```

</CodeSurfer>


---

## Eksempler på custom hooks

---

<CodeSurfer>


```ts
const useDocumentTitle = (title: string) => {
  useEffect(() => {
    document.title = title;
  }, [title]);
};
```

</CodeSurfer>


---

<CodeSurfer>


```ts
const useFavicon = (href: string) => {
  useEffect(() => {
    const link =
      document.querySelector("link[rel*='icon']") ||
      document.createElement('link');
    link.type = 'image/x-icon';
    link.rel = 'shortcut icon';
    link.href = href;
    document
      .getElementsByTagName('head')[0]
      .appendChild(link);
  }, [href]);
};
```

</CodeSurfer>


---

<CodeSurfer>


```ts
import { useRef, useEffect } from 'react';

function useInterval(
  callback: Function,
  delay: number,
  deps: React.DependencyList = [],
) {
  const savedCallback = useRef<Function>(() => {});

  // Remember the latest callback.
  useEffect(() => {
    savedCallback.current = callback;
  }, [callback]);

  // Set up the interval.
  useEffect(() => {
    function tick() {
      savedCallback.current();
    }

    let id = setInterval(tick, delay);
    return () => clearInterval(id);
  }, [delay].concat(deps));
}
```

</CodeSurfer>


---

<CodeSurfer>


```js
const useArray = (initial) => {
  const [value, setValue] = useState(initial);
  return {
    value,
    setValue,
    add: useCallback((a) => setValue((v) => [...v, a]), []),
    clear: useCallback(() => setValue(() => []), []),
    removeById: useCallback(
      (id) =>
        setValue((arr) =>
          arr.filter((v) => v && v.id !== id),
        ),
      [],
    ),
    removeIndex: useCallback(
      (index) =>
        setValue((v) => {
          v.splice(index, 1);
          return v;
        }),
      [],
    ),
  };
};
```

</CodeSurfer>


---

<CodeSurfer>


```ts
function useActive({ onChange, refEl }) {
  const [value, setValue] = useState(false);
  const handleMouseDown = () => {
    setValue(true);
    onChange(true);
  };
  const handleMouseUp = () => {
    setValue(false);
    onChange(false);
  };
  useEffect(() => {
    if (refEl && refEl.current) {
      refEl.current.addEventListener(
        'mousedown',
        handleMouseDown,
      );
      refEl.current.addEventListener(
        'mouseup',
        handleMouseUp,
      );
    }
    return () => {
      if (refEl && refEl.current) {
        refEl.current.removeEventListener(
          'mousedown',
          handleMouseDown,
        );
        refEl.current.removeEventListener(
          'mouseup',
          handleMouseUp,
        );
      }
    };
  }, []);

  return value;
}
```

</CodeSurfer>


---

## Det som kan trekkes ut,

## burde trekkes ut.

Om ikke for gjenbrukbarhet, så for lesbarhet.

---

## Custom hooks typing tips

---

<CodeSurfer>


```ts subtitle="Hva om vi ønsker å tilby reload funksjon?"
function useFetchGithubAvatar(username: string) {
  const [avatar, setAvatar] = React.useState<string | null>(
    null,
  );

  React.useEffect(() => {
    const controller = new AbortController();
    const getData = async () => {
      const opts = { signal: controller.signal };
      const result = await fetch(
        `https://api.github.com/users/${username}`,
        opts,
      );
      const data = await result.json();

      setAvatar(data.avatar_url);
    };

    getData();
    return () => controller.abort();
  }, [username]);

  return avatar;
}
```

```ts
function useFetchGithubAvatar(username: string) {
  const [avatar, setAvatar] = React.useState<string | null>(
    null,
  );

  const reload = () => {
    const controller = new AbortController();
    const getData = async () => {
      const opts = { signal: controller.signal };
      const result = await fetch(
        `https://api.github.com/users/${username}`,
        opts,
      );
      const data = await result.json();

      setAvatar(data.avatar_url);
    };
    getData();
    return () => controller.abort();
  };

  React.useEffect(reload, [username]);

  return avatar;
}
```

```ts
function useFetchGithubAvatar(username: string) {
  const [avatar, setAvatar] = React.useState<string | null>(
    null,
  );

  const reload = () => {
    const controller = new AbortController();
    const getData = async () => {
      const opts = { signal: controller.signal };
      const result = await fetch(
        `https://api.github.com/users/${username}`,
        opts,
      );
      const data = await result.json();

      setAvatar(data.avatar_url);
    };
    getData();
    return () => controller.abort();
  };

  React.useEffect(reload, [reload]);

  return avatar;
}
```

```ts subtitle="Blir feil for reload lages på ny for hver gang!"
function useFetchGithubAvatar(username: string) {
  const [avatar, setAvatar] = React.useState<string | null>(
    null,
  );

  const reload = () => {
    const controller = new AbortController();
    const getData = async () => {
      const opts = { signal: controller.signal };
      const result = await fetch(
        `https://api.github.com/users/${username}`,
        opts,
      );
      const data = await result.json();

      setAvatar(data.avatar_url);
    };
    getData();
    return () => controller.abort();
  };

  React.useEffect(reload, [reload]);

  return avatar;
}
```

```ts
function useFetchGithubAvatar(username: string) {
  const [avatar, setAvatar] = React.useState<string | null>(
    null,
  );

  const reload = React.useCallback(() => {
    const controller = new AbortController();
    const getData = async () => {
      const opts = { signal: controller.signal };
      const result = await fetch(
        `https://api.github.com/users/${username}`,
        opts,
      );
      const data = await result.json();

      setAvatar(data.avatar_url);
    };
    getData();
    return () => controller.abort();
  }, [username]);

  React.useEffect(reload, [reload]);

  return avatar;
}
```

```ts 22
function useFetchGithubAvatar(username: string) {
  const [avatar, setAvatar] = React.useState<string | null>(
    null,
  );

  const reload = React.useCallback(() => {
    const controller = new AbortController();
    const getData = async () => {
      const opts = { signal: controller.signal };
      const result = await fetch(
        `https://api.github.com/users/${username}`,
        opts,
      );
      const data = await result.json();

      setAvatar(data.avatar_url);
    };
    getData();
    return () => controller.abort();
  }, [username]);

  React.useEffect(reload, [reload]);

  return avatar;
}
```

```ts
function useFetchGithubAvatar(username: string) {
  const [avatar, setAvatar] = React.useState<string | null>(
    null,
  );

  const reload = React.useCallback(() => {
    const controller = new AbortController();
    const getData = async () => {
      const opts = { signal: controller.signal };
      const result = await fetch(
        `https://api.github.com/users/${username}`,
        opts,
      );
      const data = await result.json();

      setAvatar(data.avatar_url);
    };
    getData();
    return () => controller.abort();
  }, [username]);

  React.useEffect(reload, [reload]);

  return [avatar, reload];
}
```

```ts subtitle="Må ha typing"
function useFetchGithubAvatar(
  username: string,
): [string | null, () => void] {
  const [avatar, setAvatar] = React.useState<string | null>(
    null,
  );

  const reload = React.useCallback(() => {
    const controller = new AbortController();
    const getData = async () => {
      const opts = { signal: controller.signal };
      const result = await fetch(
        `https://api.github.com/users/${username}`,
        opts,
      );
      const data = await result.json();

      setAvatar(data.avatar_url);
    };
    getData();
    return () => controller.abort();
  }, [username]);

  React.useEffect(reload, [reload]);

  return [avatar, reload];
}
```

```ts 3[4:31] subtitle="Dette er dårlig API. Hva betyr dette??"
function useFetchGithubAvatar(
  username: string,
): [string | null, () => void] {
  const [avatar, setAvatar] = React.useState<string | null>(
    null,
  );

  const reload = React.useCallback(() => {
    const controller = new AbortController();
    const getData = async () => {
      const opts = { signal: controller.signal };
      const result = await fetch(
        `https://api.github.com/users/${username}`,
        opts,
      );
      const data = await result.json();

      setAvatar(data.avatar_url);
    };
    getData();
    return () => controller.abort();
  }, [username]);

  React.useEffect(reload, [reload]);

  return [avatar, reload];
}
```

```ts 3[4:46] subtitle="Kan navngi bedre med TypeScript 4"
function useFetchGithubAvatar(
  username: string,
): [avatar: string | null, reload: () => void] {
  const [avatar, setAvatar] = React.useState<string | null>(
    null,
  );

  const reload = React.useCallback(() => {
    const controller = new AbortController();
    const getData = async () => {
      const opts = { signal: controller.signal };
      const result = await fetch(
        `https://api.github.com/users/${username}`,
        opts,
      );
      const data = await result.json();

      setAvatar(data.avatar_url);
    };
    getData();
    return () => controller.abort();
  }, [username]);

  React.useEffect(reload, [reload]);

  return [avatar, reload];
}
```

</CodeSurfer>


---

## Oppgaver:

Skriv en custom hook for en counter med increment og decrement

(avansert) Skriv en custom hook for å polle data fra Github trend-api. Tips (se `useInterval`):

https://ghapi.huchen.dev/repositories?language=javascript

---

## Context

---

Noen ganger kan det bli tungvindt å sende data over flere ledd.

Eller du ønsker å samle tilstandsendringer på ett sted.

---

<Image src={imgs.context} />

---

### Klassiske Eksempler

1. Theming
1. Språkstøtte
1. "Global atom state"
1. "Module atom state"

---

<CodeSurfer>


```ts title="Gitt modeller"
type Theme = {};
type Themes = {
  light: Theme;
  dark: Theme;
};
const themes: Themes = {
  light: {},
  dark: {},
};
```

```ts
type Theme = {};
type Themes = {
  light: Theme;
  dark: Theme;
};
const themes: Themes = {
  light: {},
  dark: {},
};

type ThemeContextValue = {
  theme: Theme;
  updateTheme(themeKey: keyof Themes): void;
};
```

```ts 7,8,13
type Theme = {};
type Themes = {
  light: Theme;
  dark: Theme;
};
const themes: Themes = {
  light: {},
  dark: {},
};

type ThemeContextValue = {
  theme: Theme;
  updateTheme(themeKey: keyof Themes): void;
};
```

```ts
type Theme = {};
type Themes = {
  light: Theme;
  dark: Theme;
};
const themes: Themes = {
  light: {},
  dark: {},
};

type ThemeContextValue = {
  theme: Theme;
  updateTheme(themeKey: keyof Themes): void;
};

const ThemeContext = createContext<ThemeContextValue>({
  theme: themes.light,
  updateTheme() {},
});

export default ThemeContext;
```

</CodeSurfer>


---

<CodeSurferColumns themes={[dracula, github]} sizes={[2,1]}>


<Step>


```ts
import ThemeContext from './themeContext.ts';

function App() {
  const [themeName, updateTheme] = useState<keyof Themes>(
    'light',
  );
  const theme = themes[themeName];

  return (
    <ThemeContext.Provider value={{ theme, updateTheme }}>
      <main>
        <h1>Hello, World!</h1>
      </main>
    </ThemeContext.Provider>
  );
}
```

```ts
// file: themeContext.ts

type Theme = {};
type Themes = {
  light: Theme;
  dark: Theme;
};
const themes: Themes = {
  light: {},
  dark: {},
};

type ThemeContextValue = {
  theme: Theme;
  updateTheme(themeKey: keyof Themes): void;
};

const ThemeContext = createContext<ThemeContextValue>({
  theme: themes.light,
  updateTheme() {},
});

export default ThemeContext;
```

</Step>


<Step>


```ts 4:7
import ThemeContext from './themeContext.ts';

function App() {
  const [themeName, updateTheme] = useState<keyof Themes>(
    'light',
  );
  const theme = themes[themeName];

  return (
    <ThemeContext.Provider value={{ theme, updateTheme }}>
      <main>
        <h1>Hello, World!</h1>
      </main>
    </ThemeContext.Provider>
  );
}
```

```ts
// file: themeContext.ts

type Theme = {};
type Themes = {
  light: Theme;
  dark: Theme;
};
const themes: Themes = {
  light: {},
  dark: {},
};

type ThemeContextValue = {
  theme: Theme;
  updateTheme(themeKey: keyof Themes): void;
};

const ThemeContext = createContext<ThemeContextValue>({
  theme: themes.light,
  updateTheme() {},
});

export default ThemeContext;
```

</Step>


<Step subtitle="Abstraksjonslekasje">


```ts 10,14
import ThemeContext from './themeContext.ts';

function App() {
  const [themeName, updateTheme] = useState<keyof Themes>(
    'light',
  );
  const theme = themes[themeName];

  return (
    <ThemeContext.Provider value={{ theme, updateTheme }}>
      <main>
        <h1>Hello, World!</h1>
      </main>
    </ThemeContext.Provider>
  );
}
```

```ts
// file: themeContext.ts

type Theme = {};
type Themes = {
  light: Theme;
  dark: Theme;
};
const themes: Themes = {
  light: {},
  dark: {},
};

type ThemeContextValue = {
  theme: Theme;
  updateTheme(themeKey: keyof Themes): void;
};

const ThemeContext = createContext<ThemeContextValue>({
  theme: themes.light,
  updateTheme() {},
});

export default ThemeContext;
```

</Step>


<Step subtitle="Bedre">


```ts
import ThemeContextProvider from './themeContext.ts';

function App() {
  return (
    <ThemeContextProvider>
      <main>
        <h1>Hello, World!</h1>
      </main>
    </ThemeContextProvider>
  );
}
```

```ts
// file: themeContext.ts

type Theme = {};
type Themes = {
  light: Theme;
  dark: Theme;
};
const themes: Themes = {
  light: {},
  dark: {},
};

type ThemeContextValue = {
  theme: Theme;
  updateTheme(themeKey: keyof Themes): void;
};

const ThemeContext = createContext<ThemeContextValue>({
  theme: themes.light,
  updateTheme() {},
});

export default function ThemeContextProvider({
  children,
}: React.PropsWithChildren<{}>) {
  const [themeName, updateTheme] = useState<keyof Themes>(
    'light',
  );
  const theme = themes[themeName];

  return (
    <ThemeContext.Provider value={{ theme, updateTheme }}>
      {children}
    </ThemeContext.Provider>
  );
}
```

</Step>


<Step>


```ts
import ThemeContextProvider from './themeContext.ts';

function App() {
  return (
    <ThemeContextProvider>
      <main>
        <h1>Hello, World!</h1>
      </main>
    </ThemeContextProvider>
  );
}

function MyButton() {
  return (
    <button style={{ backgroundColor: '#f00' }}>
      Click me!
    </button>
  );
}
```

```diff

```

</Step>


<Step>


```ts
import ThemeContextProvider, {
  ThemeContext,
} from './themeContext.ts';

function App() {
  return (
    <ThemeContextProvider>
      <main>
        <h1>Hello, World!</h1>
      </main>
    </ThemeContextProvider>
  );
}

function MyButton() {
  return (
    <button style={{ backgroundColor: '#f00' }}>
      Click me!
    </button>
  );
}
```

```ts
// file: themeContext.ts

type Theme = {};
type Themes = {
  light: Theme;
  dark: Theme;
};
const themes: Themes = {
  light: {},
  dark: {},
};

type ThemeContextValue = {
  theme: Theme;
  updateTheme(themeKey: keyof Themes): void;
};

const ThemeContext = createContext<ThemeContextValue>({
  theme: themes.light,
  updateTheme() {},
});

export { ThemeContext };

export default function ThemeContextProvider({
  children,
}: React.PropsWithChildren<{}>) {
  const [themeName, updateTheme] = useState<keyof Themes>(
    'light',
  );
  const theme = themes[themeName];

  return (
    <ThemeContext.Provider value={{ theme, updateTheme }}>
      {children}
    </ThemeContext.Provider>
  );
}
```

</Step>
<Step>


```ts
import ThemeContextProvider, {
  ThemeContext,
} from './themeContext.ts';

function App() {
  return (
    <ThemeContextProvider>
      <main>
        <h1>Hello, World!</h1>
      </main>
    </ThemeContextProvider>
  );
}

function MyButton() {
  const { theme } = React.useContext(ThemeContext);
  return (
    <button style={{ backgroundColor: '#f00' }}>
      Click me!
    </button>
  );
}
```

```diff

```

</Step>


<Step>


```ts
import ThemeContextProvider, {
  ThemeContext,
} from './themeContext.ts';

function App() {
  return (
    <ThemeContextProvider>
      <main>
        <h1>Hello, World!</h1>
      </main>
    </ThemeContextProvider>
  );
}

function MyButton() {
  const { theme } = React.useContext(ThemeContext);
  return (
    <button style={{ backgroundColor: theme.background }}>
      Click me!
    </button>
  );
}
```

```diff

```

</Step>


<Step>


```ts 16 subtitle="Hva om context ikke er satt av en provider?"
import ThemeContextProvider, {
  ThemeContext,
} from './themeContext.ts';

function App() {
  return (
    <ThemeContextProvider>
      <main>
        <h1>Hello, World!</h1>
      </main>
    </ThemeContextProvider>
  );
}

function MyButton() {
  const { theme } = React.useContext(ThemeContext);
  return (
    <button style={{ backgroundColor: theme.background }}>
      Click me!
    </button>
  );
}
```

```diff

```

</Step>


<Step>


```ts 4
import ThemeContextProvider, {
  ThemeContext,
} from './themeContext.ts';

function App() {
  return (
    <ThemeContextProvider>
      <main>
        <h1>Hello, World!</h1>
      </main>
    </ThemeContextProvider>
  );
}

function MyButton() {
  const { theme } = React.useContext(ThemeContext);
  return (
    <button style={{ backgroundColor: theme.background }}>
      Click me!
    </button>
  );
}
```

```ts
// file: themeContext.ts

type Theme = {};
type Themes = {
  light: Theme;
  dark: Theme;
};
const themes: Themes = {
  light: {},
  dark: {},
};

type ThemeContextValue = {
  theme: Theme;
  updateTheme(themeKey: keyof Themes): void;
};

const ThemeContext = createContext<ThemeContextValue>({
  theme: themes.light,
  updateTheme() {},
});

export function useTheme() {
  const context = React.useContext(ThemeContext);
  if (context === undefined) {
    throw new Error(
      'useTheme must be used within a ThemeContextProvider',
    );
  }
  return context;
}

export default function ThemeContextProvider({
  children,
}: React.PropsWithChildren<{}>) {
  const [themeName, updateTheme] = useState<keyof Themes>(
    'light',
  );
  const theme = themes[themeName];

  return (
    <ThemeContext.Provider value={{ theme, updateTheme }}>
      {children}
    </ThemeContext.Provider>
  );
}
```

</Step>


<Step>


```ts
import ThemeContextProvider, {
  useTheme,
} from './themeContext.ts';

function App() {
  return (
    <ThemeContextProvider>
      <main>
        <h1>Hello, World!</h1>
      </main>
    </ThemeContextProvider>
  );
}

function MyButton() {
  const { theme } = useTheme();
  return (
    <button style={{ backgroundColor: theme.background }}>
      Click me!
    </button>
  );
}
```

```ts 23:31
// file: themeContext.ts

type Theme = {};
type Themes = {
  light: Theme;
  dark: Theme;
};
const themes: Themes = {
  light: {},
  dark: {},
};

type ThemeContextValue = {
  theme: Theme;
  updateTheme(themeKey: keyof Themes): void;
};

const ThemeContext = createContext<ThemeContextValue>({
  theme: themes.light,
  updateTheme() {},
});

export function useTheme() {
  const context = React.useContext(ThemeContext);
  if (context === undefined) {
    throw new Error(
      'useTheme must be used within a ThemeContextProvider',
    );
  }
  return context;
}

export default function ThemeContextProvider({
  children,
}: React.PropsWithChildren<{}>) {
  const [themeName, updateTheme] = useState<keyof Themes>(
    'light',
  );
  const theme = themes[themeName];

  return (
    <ThemeContext.Provider value={{ theme, updateTheme }}>
      {children}
    </ThemeContext.Provider>
  );
}
```

</Step>


</CodeSurferColumns>


---

## Kjørende kode

http://var.show/akva-context-theme

---

## Oppgaver

1. Utvid Theme context til å lagre theme navn og mulighet til å toggle theme.
1. Lag en count context som lar deg increment & decrement uansett hvor (bruk sammen med useReducer).
1. (avansert) Lag en `LocaleDateFormat` context som har et språk og lar deg formatere `Date`-objekter.
